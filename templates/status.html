<!DOCTYPE html>
<html>
<head>
    <title>仮想マシンを起動中</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
</head>
<body>
    <div class="header-logo">
        <img src="{{ url_for('static', filename='images/header-logo.avif') }}" alt="RHSC2025 Tokyo Virtual Machine Deployment">
    </div>
    <h1>仮想マシンを起動中！</h1>
    <div id="status-message">処理中です...</div>
    <pre id="logs-container"></pre>
    <div id="result"></div>

    <script>
        const jobName = "{{ job_name }}";
        const statusMessage = document.getElementById('status-message');
        const logsContainer = document.getElementById('logs-container');
        const resultDiv = document.getElementById('result');
        let pollingInterval;

        // Jobの完了状態をチェックし、最終結果を表示する
        function checkJobCompletion() {
            fetch(`/api/job-status/${jobName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'succeeded') {
                        statusMessage.textContent = '完了しました！';
                        resultDiv.innerHTML = `<p>VMは <a href="${data.url}" target="_blank">${data.url}</a> にて起動しています。</p>`;
                    } else if (data.status === 'failed' || data.status === 'error') {
                        statusMessage.textContent = 'デプロイに失敗しました。';
                        resultDiv.textContent = `エラー: ${data.message}`;
                    } else {
                        // Jobがまだ完了していない場合、ポーリングを継続
                        setTimeout(checkJobCompletion, 5000);
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                });
        }

        // Jobのログをポーリングしてリアルタイムに表示
        function pollLogs() {
            fetch(`/api/job-logs/${jobName}`)
                .then(response => response.text())
                .then(logs => {
                    logsContainer.textContent = logs;
                    logsContainer.scrollTop = logsContainer.scrollHeight;

                    // ログに完了を示すキーワードが含まれていればポーリングを停止し、最終状態をチェック
                    if (logs.includes('Application is ready')) { // ★修正点
                        clearInterval(pollingInterval);
                        checkJobCompletion();
                    }
                })
                .catch(error => {
                    console.error('Error fetching logs:', error);
                    // エラー発生時も完了チェックを試みる
                    clearInterval(pollingInterval);
                    checkJobCompletion();
                });
        }

        window.onload = function() {
            // ページ読み込み後、すぐにログのポーリングを開始
            pollingInterval = setInterval(pollLogs, 5000);
        };
    </script>
</body>
</html>
